name: TODO â†’ Issue (no duplicati)

on:
  push:
    branches: [main]

jobs:
  todo-to-issues:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Autentica gh CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "$GH_TOKEN" | gh auth login --with-token

      - name: Cerca TODO nei file modificati e crea issue (evita duplicati)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FILES=$(git diff --name-only HEAD HEAD~1)

          if [ -z "$FILES" ]; then
            echo "ðŸ›‘ Nessun file modificato. Nessuna azione da intraprendere."
            exit 0
          fi

          for FILE in $FILES; do
            if file "$FILE" | grep -q text; then
              grep -n "TODO:" "$FILE" | while IFS= read -r line; do
                LINE_NUM=$(echo "$line" | cut -d: -f1)
                TODO_TEXT=$(echo "$line" | cut -d: -f2- | sed 's/^ *//')
                ISSUE_TITLE="ðŸ“Œ TODO trovato in $FILE, linea $LINE_NUM"
                ISSUE_BODY="Ãˆ stato trovato un TODO nel file \`$FILE\`, linea \`$LINE_NUM\`:\n\n> $TODO_TEXT\n\n> Generato automaticamente da GitHub Actions."

                EXISTING_ISSUE=$(gh issue list --state open --json title -q ".[] | select(.title == \"$ISSUE_TITLE\")")

                if [ -z "$EXISTING_ISSUE" ]; then
                  echo "âž• Creazione nuova issue: $ISSUE_TITLE"
                  gh issue create \
                    --title "$ISSUE_TITLE" \
                    --body "$ISSUE_BODY" \
                    --label "todo"
                else
                  echo "ðŸ›‘ Issue giÃ  esistente: $ISSUE_TITLE"
                fi
              done
            fi
          done
