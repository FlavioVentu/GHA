name: Convert TODO to Issues from Modified Files (with Duplicate Check)

on:
  push:
    branches: [main]

jobs:
  todo-to-issues:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: cli/cli-action@v2

      - name: Cerca TODO nei file modificati e crea issue (evita duplicati)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” Cercando TODO nei file modificati..."

          # Ottieni i file modificati nell'ultimo commit
          FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})

          if [ -z "$FILES" ]; then
            echo "ðŸ›‘ Nessun file modificato. Nessuna azione da intraprendere."
            exit 0
          fi

          echo "ðŸ“‚ File modificati: $FILES"

          for FILE in $FILES; do
            # Verifica se il file Ã¨ un file di testo (ignoriamo binari)
            if file "$FILE" | grep -q text; then
              echo "ðŸ” Cercando TODO in $FILE"

              # Cerca TODO in ogni file modificato
              grep -n "TODO:" "$FILE" | while IFS= read -r line; do
                LINE_NUM=$(echo "$line" | cut -d: -f1)
                TODO_TEXT=$(echo "$line" | cut -d: -f2- | sed 's/^ *//')

                # Titolo dell'issue basato su file e linea per evitare duplicati
                ISSUE_TITLE="ðŸ“Œ TODO trovato in $FILE, linea $LINE_NUM"
                ISSUE_BODY="Ãˆ stato trovato un TODO nel file \`$FILE\`, linea \`$LINE_NUM\`:\n\n> $TODO_TEXT\n\n> Generato automaticamente da GitHub Actions."

                # Verifica se esiste giÃ  un'issue con lo stesso titolo
                EXISTING_ISSUE=$(gh issue list --state open --json title -q ".[] | select(.title == \"$ISSUE_TITLE\")")

                if [ -z "$EXISTING_ISSUE" ]; then
                  echo "âž• Creando nuova issue per: $FILE:$LINE_NUM"
                  gh issue create \
                    --title "$ISSUE_TITLE" \
                    --body "$ISSUE_BODY" \
                    --label "todo"
                else
                  echo "ðŸ›‘ Issue giÃ  esistente: $ISSUE_TITLE"
                fi
              done
            fi
          done
